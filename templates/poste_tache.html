<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ poste.nom }} - WoodStock</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root {
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #1a1a2e;
            --text-muted: #6c757d;
            --primary: #2563eb;
            --success: #059669;
            --success-bg: #ecfdf5;
            --warning: #d97706;
            --warning-bg: #fffbeb;
            --danger: #dc2626;
            --border: #e5e7eb;
            --radius: 12px;
            --shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100dvh;
            padding-bottom: 2rem;
        }
        header {
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .back { color: var(--primary); text-decoration: none; font-size: 0.9rem; font-weight: 500; }
        header h1 { font-size: 1rem; font-weight: 600; flex: 1; }
        .header-btn {
            width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
            background: var(--bg); border: none; border-radius: 8px;
            text-decoration: none; font-size: 1rem;
        }
        .header-btn:hover { background: var(--border); }
        main { max-width: 480px; margin: 0 auto; padding: 1rem; }
        
        .toast {
            position: fixed; top: 4.5rem; left: 50%;
            transform: translateX(-50%) translateY(-20px);
            padding: 0.75rem 1.25rem; border-radius: 8px;
            font-size: 0.9rem; font-weight: 500;
            opacity: 0; transition: all 0.3s; z-index: 100;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--success); color: white; }
        .toast.error { background: var(--danger); color: white; }
        
        .card {
            background: var(--card); border-radius: var(--radius);
            padding: 1rem; margin-bottom: 0.875rem; box-shadow: var(--shadow);
        }
        .card.highlight { border: 2px solid var(--primary); }
        .card.highlight-warning { border: 2px solid var(--warning); background: var(--warning-bg); }
        .card-title {
            font-size: 0.7rem; font-weight: 600; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.75rem;
        }
        .card.highlight .card-title { color: var(--primary); }
        .card.highlight-warning .card-title { color: var(--warning); }
        
        .numero-display { text-align: center; padding: 1.5rem 1rem; }
        .numero-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        .numero-value { font-size: 2.75rem; font-weight: 700; font-family: 'SF Mono', monospace; letter-spacing: 0.05em; }
        .numero-serie { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem; }
        
        .form-group { margin-bottom: 0.875rem; }
        .form-group:last-child { margin-bottom: 0; }
        .form-group label { display: block; font-size: 0.8rem; font-weight: 500; margin-bottom: 0.375rem; color: var(--text-muted); }
        .form-group input, .form-group select {
            width: 100%; padding: 0.625rem 0.75rem;
            border: 1px solid var(--border); border-radius: 8px;
            font-size: 0.95rem; background: white;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        
        .source-tabs { display: flex; gap: 0.5rem; margin-bottom: 0.875rem; }
        .source-tab {
            flex: 1; padding: 0.625rem; border: 2px solid var(--border);
            border-radius: 8px; background: white; font-size: 0.85rem;
            font-weight: 500; cursor: pointer; text-align: center;
        }
        .source-tab.active { border-color: var(--primary); background: #eff6ff; color: var(--primary); }
        .source-content { display: none; }
        .source-content.active { display: block; }
        
        .selected-source {
            background: var(--success-bg); border: 2px solid var(--success);
            border-radius: 8px; padding: 0.875rem; margin-top: 0.875rem; display: none;
        }
        .selected-source.show { display: flex; align-items: center; gap: 0.75rem; }
        .selected-source .icon { font-size: 1.25rem; }
        .selected-source .info { flex: 1; }
        .selected-source .label { font-size: 0.7rem; color: var(--success); text-transform: uppercase; font-weight: 600; }
        .selected-source .value { font-size: 1.1rem; font-weight: 700; font-family: 'SF Mono', monospace; color: #065f46; }
        .selected-source .clear { background: none; border: none; color: var(--success); font-size: 1.25rem; cursor: pointer; }
        
        .scan-btn {
            width: 100%; padding: 0.875rem; background: var(--primary); color: white;
            border: none; border-radius: 8px; font-size: 0.95rem; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .scan-btn:hover { background: #1d4ed8; }
        .scan-btn.active { background: var(--danger); }
        #qr-reader { margin-top: 0.875rem; border-radius: 8px; overflow: hidden; display: none; }
        #qr-reader.show { display: block; }
        
        .inline-row { display: flex; align-items: center; gap: 0.75rem; }
        .inline-row label { flex: 1; margin: 0; font-size: 0.9rem; color: var(--text); }
        .copies-input { width: 70px !important; text-align: center; font-weight: 600; }
        input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--primary); }
        
        .print-btn {
            width: 100%; padding: 1rem; background: var(--success); color: white;
            border: none; border-radius: var(--radius); font-size: 1.05rem;
            font-weight: 600; cursor: pointer; margin-top: 0.5rem;
        }
        .print-btn:hover { background: #047857; }
        .print-btn:active { transform: scale(0.98); }
        .print-btn:disabled { background: var(--text-muted); cursor: not-allowed; }
    </style>
</head>
<body>
    <header>
        <a href="/" class="back">‚Üê Accueil</a>
        <h1>{{ poste.nom }}</h1>
        {% if session.get('user_droits') == 'admin' %}
        <a href="/poste/{{ poste.id }}/liste" class="header-btn">üìã</a>
        <a href="/poste/{{ poste.id }}/parametres" class="header-btn">‚öôÔ∏è</a>
        {% endif %}
    </header>

    <div id="toast" class="toast"></div>

    <main>
        {% if poste.source_poste %}
        <div class="card highlight">
            <div class="card-title">üîó Tron√ßon source</div>
            <div class="source-tabs">
                <button class="source-tab active" onclick="switchTab('manual')">üìù Saisie</button>
                <button class="source-tab" onclick="switchTab('scan')">üì∑ Scanner</button>
            </div>
            <div class="source-content active" id="tab-manual">
                <div class="form-row">
                    <div class="form-group">
                        <label>S√©rie</label>
                        <select id="source-serie" onchange="loadNumeros()"><option value="">‚Äî</option></select>
                    </div>
                    <div class="form-group">
                        <label>Num√©ro</label>
                        <select id="source-numero" onchange="selectSource()"><option value="">‚Äî</option></select>
                    </div>
                </div>
            </div>
            <div class="source-content" id="tab-scan">
                <button class="scan-btn" id="scan-btn" onclick="toggleScanner()">üì∑ Activer la cam√©ra</button>
                <div id="qr-reader"></div>
            </div>
            <div class="selected-source" id="selected-source">
                <span class="icon">‚úì</span>
                <div class="info">
                    <div class="label">S√©lectionn√©</div>
                    <div class="value" id="source-value"></div>
                </div>
                <button class="clear" onclick="clearSource()">‚úï</button>
            </div>
        </div>
        {% endif %}

        {% if poste.type_produit %}
        <div class="card highlight-warning">
            <div class="card-title">ü™µ Produit</div>
            <div class="form-group">
                <label>Essence</label>
                <select id="essence" onchange="loadQualitesEpaisseurs()"><option value="">‚Äî S√©lectionner ‚Äî</option></select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Qualit√©</label>
                    <select id="qualite"><option value="">‚Äî</option></select>
                </div>
                <div class="form-group">
                    <label>√âpaisseur</label>
                    <select id="epaisseur"><option value="">‚Äî</option></select>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card numero-display">
            <div class="numero-label">Prochain num√©ro</div>
            <div class="numero-value" id="numero">{{ '%02d %02d %02d' % (poste.compteur // 10000, (poste.compteur // 100) % 100, poste.compteur % 100) }}</div>
            <div class="numero-serie">S√©rie {{ poste.serie }} ¬∑ {{ poste.prefixe or '' }}</div>
        </div>

        {% if poste.champs %}
        <div class="card">
            <div class="card-title">Informations</div>
            {% for champ in poste.champs %}
            <div class="form-group">
                <label>{{ champ.nom }}</label>
                {% if champ.type == 'select' and champ.options %}
                <select id="field-{{ champ.id }}">
                    {% for opt in champ.options %}<option value="{{ opt }}">{{ opt }}</option>{% endfor %}
                </select>
                {% else %}
                <input type="{{ champ.type or 'text' }}" id="field-{{ champ.id }}" placeholder="{{ champ.placeholder or '' }}">
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="card">
            <div class="inline-row" style="margin-bottom: 0.75rem;">
                <label>Nombre de copies</label>
                <input type="number" id="copies" class="copies-input" value="{{ poste.copies_defaut or 1 }}" min="1" max="50">
            </div>
            <div class="inline-row">
                <input type="checkbox" id="imprimer" checked>
                <label for="imprimer">Imprimer l'√©tiquette</label>
            </div>
        </div>

        <button class="print-btn" id="btn-print" onclick="doPrint()">‚úì Valider et imprimer</button>
    </main>

    <script>
        const posteId = '{{ poste.id }}';
        const champs = {{ poste.champs | tojson }};
        const sourcePoste = '{{ poste.source_poste or "" }}';
        const typeProduit = '{{ poste.type_produit or "" }}';
        let compteur = {{ poste.compteur }};
        let scanner = null, isScanning = false, selectedSource = null;
        let seriesData = {}, essences = [], qualites = [], epaisseurs = [];

        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            if (sourcePoste) loadSeries();
            if (typeProduit) loadEssences();
        }

        // Essences
        async function loadEssences() {
            try {
                const res = await fetch('/api/tables/essences/values');
                essences = await res.json();
                const sel = document.getElementById('essence');
                sel.innerHTML = '<option value="">‚Äî S√©lectionner ‚Äî</option>' +
                    essences.map(e => `<option value="${e.Code || e.code}">${e.Code || e.code} - ${e.Nom || e.nom}</option>`).join('');
            } catch (e) { console.error(e); }
        }

        async function loadQualitesEpaisseurs() {
            const code = document.getElementById('essence').value;
            const selQ = document.getElementById('qualite');
            const selE = document.getElementById('epaisseur');
            
            if (!code) {
                selQ.innerHTML = selE.innerHTML = '<option value="">‚Äî</option>';
                return;
            }
            
            // Qualit√©s
            try {
                const res = await fetch(`/api/qualites/${code}/${typeProduit}`);
                qualites = await res.json();
                selQ.innerHTML = qualites.length 
                    ? '<option value="">‚Äî</option>' + qualites.map(q => `<option value="${q.Code || q.code}">${q.Code || q.code} - ${q.Nom || q.nom}</option>`).join('')
                    : '<option value="">Aucune</option>';
            } catch (e) { selQ.innerHTML = '<option value="">Erreur</option>'; }
            
            // √âpaisseurs
            try {
                const res = await fetch(`/api/epaisseurs/${code}`);
                epaisseurs = await res.json();
                selE.innerHTML = epaisseurs.length
                    ? '<option value="">‚Äî</option>' + epaisseurs.map(ep => {
                        const f = ep['√âp. frais (mm)'] || ep.ep_frais;
                        const s = ep['√âp. sec (mm)'] || ep.ep_sec;
                        return `<option value="${f}/${s}">${f} ‚Üí ${s} mm</option>`;
                    }).join('')
                    : '<option value="">Aucune</option>';
            } catch (e) { selE.innerHTML = '<option value="">Erreur</option>'; }
        }

        // Source
        async function loadSeries() {
            try {
                const res = await fetch('/api/poste/' + sourcePoste + '/series');
                seriesData = await res.json();
                const sel = document.getElementById('source-serie');
                sel.innerHTML = '<option value="">‚Äî</option>' + 
                    Object.keys(seriesData).sort().reverse().map(s => `<option value="${s}">${s}</option>`).join('');
            } catch (e) { console.error(e); }
        }

        function loadNumeros() {
            const serie = document.getElementById('source-serie').value;
            const sel = document.getElementById('source-numero');
            if (!serie || !seriesData[serie]) { sel.innerHTML = '<option value="">‚Äî</option>'; return; }
            sel.innerHTML = '<option value="">‚Äî</option>' + 
                seriesData[serie].slice().reverse().map(n => {
                    const f = n.padStart(6, '0');
                    return `<option value="${n}">${f.slice(0,2)} ${f.slice(2,4)} ${f.slice(4,6)}</option>`;
                }).join('');
        }

        function selectSource() {
            const serie = document.getElementById('source-serie').value;
            const numero = document.getElementById('source-numero').value;
            if (serie && numero) {
                const f = numero.padStart(6, '0');
                setSelectedSource(`TRO-${serie}-${numero}`, `${serie} / ${f.slice(0,2)} ${f.slice(2,4)} ${f.slice(4,6)}`);
            }
        }

        function setSelectedSource(code, display) {
            selectedSource = code;
            document.getElementById('source-value').textContent = display || code;
            document.getElementById('selected-source').classList.add('show');
            if (navigator.vibrate) navigator.vibrate(100);
        }

        function clearSource() {
            selectedSource = null;
            document.getElementById('selected-source').classList.remove('show');
            document.getElementById('source-serie').value = '';
            document.getElementById('source-numero').innerHTML = '<option value="">‚Äî</option>';
        }

        function switchTab(tab) {
            document.querySelectorAll('.source-tab').forEach((t, i) => t.classList.toggle('active', (tab === 'manual' ? i === 0 : i === 1)));
            document.getElementById('tab-manual').classList.toggle('active', tab === 'manual');
            document.getElementById('tab-scan').classList.toggle('active', tab === 'scan');
            if (tab === 'manual' && isScanning) stopScanner();
        }

        // Scanner
        function toggleScanner() { isScanning ? stopScanner() : startScanner(); }

        function startScanner() {
            const btn = document.getElementById('scan-btn');
            const reader = document.getElementById('qr-reader');
            btn.innerHTML = '‚èπÔ∏è Arr√™ter'; btn.classList.add('active');
            reader.classList.add('show'); isScanning = true;
            scanner = new Html5Qrcode("qr-reader");
            
            Html5Qrcode.getCameras().then(cameras => {
                if (!cameras.length) return;
                let camId = cameras[0].id;
                for (const c of cameras) if (/back|arri√®re|rear/i.test(c.label)) { camId = c.id; break; }
                scanner.start(camId, { fps: 10, qrbox: { width: 250, height: 250 } }, onScan, () => {})
                    .catch(e => { showToast("Erreur cam√©ra", 'error'); stopScanner(); });
            }).catch(() => { showToast("Cam√©ra inaccessible", 'error'); stopScanner(); });
        }

        function stopScanner() {
            document.getElementById('scan-btn').innerHTML = 'üì∑ Activer la cam√©ra';
            document.getElementById('scan-btn').classList.remove('active');
            document.getElementById('qr-reader').classList.remove('show');
            isScanning = false;
            if (scanner) scanner.stop().then(() => scanner.clear()).catch(() => {});
        }

        function onScan(text) {
            if (navigator.vibrate) navigator.vibrate(200);
            const m = text.match(/^([A-Z]{3})-(\d+)-(\d+)$/);
            if (m) {
                const f = m[3].padStart(6, '0');
                setSelectedSource(text, `${m[2]} / ${f.slice(0,2)} ${f.slice(2,4)} ${f.slice(4,6)}`);
            } else {
                setSelectedSource(text, text);
            }
            stopScanner();
            showToast('QR scann√© !', 'success');
        }

        // Print
        async function doPrint() {
            if (sourcePoste && !selectedSource) { showToast('S√©lectionnez un tron√ßon', 'error'); return; }
            if (typeProduit && !document.getElementById('essence').value) { showToast('S√©lectionnez une essence', 'error'); return; }
            
            const btn = document.getElementById('btn-print');
            btn.disabled = true; btn.textContent = '‚è≥ En cours...';

            const data = {
                imprimer: document.getElementById('imprimer').checked,
                copies: parseInt(document.getElementById('copies').value) || 1,
                source: selectedSource
            };
            
            if (typeProduit) {
                data.essence = document.getElementById('essence').value;
                data.qualite = document.getElementById('qualite').value;
                data.epaisseur = document.getElementById('epaisseur').value;
            }
            champs.forEach(c => { const el = document.getElementById('field-' + c.id); if (el) data[c.id] = el.value; });

            try {
                const res = await fetch('/api/print/' + posteId, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                showToast(result.message, result.success ? 'success' : 'error');
                if (result.success) {
                    compteur = result.compteur;
                    updateNumero();
                    if (sourcePoste) clearSource();
                }
            } catch (e) { showToast('Erreur r√©seau', 'error'); }

            btn.disabled = false; btn.textContent = '‚úì Valider et imprimer';
        }

        function updateNumero() {
            const s = String(compteur).padStart(6, '0');
            document.getElementById('numero').textContent = `${s.slice(0,2)} ${s.slice(2,4)} ${s.slice(4,6)}`;
        }

        function showToast(text, type = 'success') {
            const t = document.getElementById('toast');
            t.textContent = text; t.className = 'toast show ' + type;
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        document.addEventListener('keypress', e => { if (e.key === 'Enter') doPrint(); });
    </script>
</body>
</html>
