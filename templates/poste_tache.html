<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ poste.nom }} - MALLO BOIS</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            min-height: 100vh;
        }
        header {
            background: #fff;
            border-bottom: 1px solid #e5e5e7;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .back { color: #007aff; text-decoration: none; }
        header h1 { font-size: 1.1rem; font-weight: 600; flex: 1; }
        .header-actions { display: flex; gap: 0.5rem; }
        .header-btn {
            padding: 0.5rem 1rem;
            background: #e5e5e7;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: none;
            color: #1d1d1f;
        }
        .header-btn:hover { background: #d2d2d7; }
        main {
            max-width: 500px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .numero-display {
            background: #fff;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .numero-label { font-size: 0.8rem; color: #86868b; margin-bottom: 0.5rem; }
        .numero-value { font-size: 3rem; font-weight: 700; font-family: 'SF Mono', monospace; }
        .numero-serie { font-size: 0.9rem; color: #86868b; margin-top: 0.5rem; }
        .section {
            background: #fff;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }
        .section h2 {
            font-size: 0.75rem;
            font-weight: 500;
            color: #86868b;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }
        .form-group { margin-bottom: 1rem; }
        .form-group:last-child { margin-bottom: 0; }
        .form-group label {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            font-size: 1rem;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #007aff;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 0.75rem;
        }
        .copies-row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .copies-row label { flex: 1; }
        .copies-input {
            width: 80px !important;
            text-align: center;
        }
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .checkbox-row input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }
        .print-btn {
            width: 100%;
            padding: 1.25rem;
            background: #34c759;
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }
        .print-btn:hover { background: #2db350; }
        .print-btn:active { transform: scale(0.98); }
        .print-btn:disabled {
            background: #86868b;
            cursor: not-allowed;
        }
        .message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }
        .message.show { display: block; }
        .message.success { background: #d4edda; color: #155724; }
        .message.error { background: #f8d7da; color: #721c24; }
        
        /* Source selector */
        .source-section {
            background: #fff;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 2px solid #007aff;
        }
        .source-section h2 {
            font-size: 0.75rem;
            font-weight: 500;
            color: #007aff;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }
        .source-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .source-tab {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e5e5e7;
            border-radius: 8px;
            background: #fff;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
        }
        .source-tab.active {
            border-color: #007aff;
            background: #e8f4fd;
            color: #007aff;
        }
        .source-content { display: none; }
        .source-content.active { display: block; }
        
        .selected-source {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }
        .selected-source.show { display: block; }
        .selected-source .label {
            font-size: 0.7rem;
            color: #2e7d32;
            text-transform: uppercase;
        }
        .selected-source .value {
            font-size: 1.3rem;
            font-weight: 700;
            font-family: 'SF Mono', monospace;
            color: #1b5e20;
        }
        .selected-source .clear {
            float: right;
            background: none;
            border: none;
            color: #2e7d32;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            line-height: 1;
        }
        
        /* Scanner QR */
        .scan-btn {
            width: 100%;
            padding: 1rem;
            background: #007aff;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .scan-btn:hover { background: #0066d6; }
        .scan-btn.active { background: #ff3b30; }
        
        #qr-reader {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 1rem;
            display: none;
        }
        #qr-reader.show { display: block; }
    </style>
</head>
<body>
    <header>
        <a href="/" class="back">‚Üê Accueil</a>
        <h1>{{ poste.nom }}</h1>
        <div class="header-actions">
            {% if session.get('user_droits') == 'admin' %}
            <a href="/poste/{{ poste.id }}/liste" class="header-btn">üìã</a>
            <a href="/poste/{{ poste.id }}/parametres" class="header-btn">‚öôÔ∏è</a>
            {% endif %}
        </div>
    </header>

    <main>
        <div id="message" class="message"></div>

        {% if poste.source_poste %}
        <!-- S√©lection source (tron√ßon) -->
        <div class="source-section">
            <h2>Tron√ßon source</h2>
            
            <div class="source-tabs">
                <button class="source-tab active" onclick="switchSourceTab('manual')">üìù Saisie</button>
                <button class="source-tab" onclick="switchSourceTab('scan')">üì∑ Scanner</button>
            </div>
            
            <!-- Saisie manuelle -->
            <div class="source-content active" id="source-manual">
                <div class="form-row">
                    <div class="form-group">
                        <label>S√©rie</label>
                        <select id="source-serie" onchange="loadNumeros()">
                            <option value="">--</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Num√©ro</label>
                        <select id="source-numero" onchange="selectSource()">
                            <option value="">-- Choisir s√©rie --</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Scanner -->
            <div class="source-content" id="source-scan">
                <button class="scan-btn" id="scan-btn" onclick="toggleScanner()">
                    üì∑ Activer la cam√©ra
                </button>
                <div id="qr-reader"></div>
            </div>
            
            <!-- Source s√©lectionn√©e -->
            <div class="selected-source" id="selected-source">
                <button class="clear" onclick="clearSource()">‚úï</button>
                <div class="label">Tron√ßon s√©lectionn√©</div>
                <div class="value" id="source-value"></div>
            </div>
        </div>
        {% endif %}

        <div class="numero-display">
            <div class="numero-label">Prochain num√©ro {{ poste.nom }}</div>
            <div class="numero-value" id="numero">{{ '%02d %02d %02d' % (poste.compteur // 10000, (poste.compteur // 100) % 100, poste.compteur % 100) }}</div>
            <div class="numero-serie">S√©rie {{ poste.serie }} ¬∑ {{ poste.prefixe or '' }}</div>
        </div>

        {% if poste.champs %}
        <div class="section">
            <h2>Informations</h2>
            {% for champ in poste.champs %}
            <div class="form-group">
                <label>{{ champ.nom }}</label>
                {% if champ.type == 'select' and champ.options %}
                <select id="field-{{ champ.id }}" name="{{ champ.id }}">
                    {% for opt in champ.options %}
                    <option value="{{ opt }}">{{ opt }}</option>
                    {% endfor %}
                </select>
                {% else %}
                <input type="{{ champ.type or 'text' }}" id="field-{{ champ.id }}" name="{{ champ.id }}" placeholder="{{ champ.placeholder or '' }}">
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="section">
            <div class="copies-row">
                <label>Nombre de copies</label>
                <input type="number" id="copies" class="copies-input" value="{{ poste.copies_defaut or 1 }}" min="1" max="50">
            </div>
        </div>

        <div class="section">
            <div class="checkbox-row">
                <input type="checkbox" id="imprimer" checked>
                <label for="imprimer">Imprimer l'√©tiquette</label>
            </div>
        </div>

        <button class="print-btn" id="btn-print" onclick="doPrint()">
            ‚úì Valider et imprimer
        </button>
    </main>

    <script>
        const posteId = '{{ poste.id }}';
        const champs = {{ poste.champs | tojson }};
        const sourcePoste = '{{ poste.source_poste or "" }}';
        let compteur = {{ poste.compteur }};
        let scanner = null;
        let isScanning = false;
        let selectedSource = null;
        let seriesData = {};

        // Charger les s√©ries si poste source
        if (sourcePoste) {
            loadSeries();
        }

        async function loadSeries() {
            try {
                const res = await fetch('/api/poste/' + sourcePoste + '/series');
                seriesData = await res.json();
                
                const select = document.getElementById('source-serie');
                select.innerHTML = '<option value="">-- S√©rie --</option>';
                
                // Trier les s√©ries (plus r√©centes en premier)
                const series = Object.keys(seriesData).sort().reverse();
                series.forEach(s => {
                    select.innerHTML += `<option value="${s}">${s}</option>`;
                });
            } catch (e) {
                console.error('Erreur chargement s√©ries:', e);
            }
        }

        function loadNumeros() {
            const serie = document.getElementById('source-serie').value;
            const select = document.getElementById('source-numero');
            
            if (!serie || !seriesData[serie]) {
                select.innerHTML = '<option value="">-- Choisir s√©rie --</option>';
                return;
            }
            
            select.innerHTML = '<option value="">-- Num√©ro --</option>';
            // Afficher les num√©ros les plus r√©cents en premier
            const numeros = seriesData[serie].slice().reverse();
            numeros.forEach(n => {
                const formatted = n.padStart(6, '0');
                const display = `${formatted.slice(0,2)} ${formatted.slice(2,4)} ${formatted.slice(4,6)}`;
                select.innerHTML += `<option value="${n}">${display}</option>`;
            });
        }

        function selectSource() {
            const serie = document.getElementById('source-serie').value;
            const numero = document.getElementById('source-numero').value;
            
            if (serie && numero) {
                const formatted = numero.padStart(6, '0');
                const display = `${formatted.slice(0,2)} ${formatted.slice(2,4)} ${formatted.slice(4,6)}`;
                setSelectedSource(`TRO-${serie}-${numero}`, `${serie} / ${display}`);
            }
        }

        function setSelectedSource(code, display) {
            selectedSource = code;
            document.getElementById('source-value').textContent = display || code;
            document.getElementById('selected-source').classList.add('show');
            
            // Vibrer si support√©
            if (navigator.vibrate) {
                navigator.vibrate(100);
            }
        }

        function clearSource() {
            selectedSource = null;
            document.getElementById('selected-source').classList.remove('show');
            document.getElementById('source-serie').value = '';
            document.getElementById('source-numero').innerHTML = '<option value="">-- Choisir s√©rie --</option>';
        }

        function switchSourceTab(tab) {
            document.querySelectorAll('.source-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.source-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`.source-tab:nth-child(${tab === 'manual' ? 1 : 2})`).classList.add('active');
            document.getElementById('source-' + tab).classList.add('active');
            
            if (tab === 'manual' && isScanning) {
                stopScanner();
            }
        }

        function updateNumero() {
            const n = compteur;
            const s = String(n).padStart(6, '0');
            document.getElementById('numero').textContent = `${s.slice(0,2)} ${s.slice(2,4)} ${s.slice(4,6)}`;
        }

        // ===== QR Scanner =====
        function toggleScanner() {
            if (isScanning) {
                stopScanner();
            } else {
                startScanner();
            }
        }

        function startScanner() {
            const btn = document.getElementById('scan-btn');
            const reader = document.getElementById('qr-reader');
            
            btn.innerHTML = '‚èπÔ∏è Arr√™ter';
            btn.classList.add('active');
            reader.classList.add('show');
            isScanning = true;

            scanner = new Html5Qrcode("qr-reader");
            
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1
            };

            Html5Qrcode.getCameras().then(cameras => {
                if (cameras && cameras.length) {
                    let cameraId = cameras[0].id;
                    for (const cam of cameras) {
                        if (cam.label.toLowerCase().includes('back') || 
                            cam.label.toLowerCase().includes('arri√®re') ||
                            cam.label.toLowerCase().includes('rear')) {
                            cameraId = cam.id;
                            break;
                        }
                    }
                    
                    scanner.start(cameraId, config, onScanSuccess, () => {})
                        .catch(err => {
                            showMessage("Erreur cam√©ra: " + err, 'error');
                            stopScanner();
                        });
                }
            }).catch(err => {
                showMessage("Impossible d'acc√©der √† la cam√©ra", 'error');
                stopScanner();
            });
        }

        function stopScanner() {
            const btn = document.getElementById('scan-btn');
            const reader = document.getElementById('qr-reader');
            
            btn.innerHTML = 'üì∑ Activer la cam√©ra';
            btn.classList.remove('active');
            reader.classList.remove('show');
            isScanning = false;

            if (scanner) {
                scanner.stop().then(() => scanner.clear()).catch(() => {});
            }
        }

        function onScanSuccess(decodedText) {
            console.log("QR scann√©:", decodedText);
            
            // Vibrer
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
            
            // Parser le QR code (format: TRO-2501-000123)
            const match = decodedText.match(/^([A-Z]{3})-(\d+)-(\d+)$/);
            if (match) {
                const serie = match[2];
                const numero = match[3];
                const formatted = numero.padStart(6, '0');
                const display = `${serie} / ${formatted.slice(0,2)} ${formatted.slice(2,4)} ${formatted.slice(4,6)}`;
                setSelectedSource(decodedText, display);
            } else {
                setSelectedSource(decodedText, decodedText);
            }
            
            stopScanner();
            showMessage('QR Code scann√© !', 'success');
        }

        // ===== Impression =====
        async function doPrint() {
            // V√©rifier source si requis
            if (sourcePoste && !selectedSource) {
                showMessage('Veuillez s√©lectionner un tron√ßon source', 'error');
                return;
            }
            
            const btn = document.getElementById('btn-print');
            btn.disabled = true;
            btn.textContent = '‚è≥ En cours...';

            const data = {
                imprimer: document.getElementById('imprimer').checked,
                copies: parseInt(document.getElementById('copies').value) || 1,
                source: selectedSource
            };

            champs.forEach(c => {
                const el = document.getElementById('field-' + c.id);
                if (el) data[c.id] = el.value;
            });

            try {
                const res = await fetch('/api/print/' + posteId, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();

                showMessage(result.message, result.success ? 'success' : 'error');

                if (result.success) {
                    compteur = result.compteur;
                    updateNumero();
                    champs.forEach(c => {
                        if (c.type !== 'select') {
                            const el = document.getElementById('field-' + c.id);
                            if (el) el.value = '';
                        }
                    });
                    // Reset source apr√®s impression r√©ussie
                    clearSource();
                }
            } catch (e) {
                showMessage('Erreur de communication', 'error');
            }

            btn.disabled = false;
            btn.textContent = '‚úì Valider et imprimer';
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = 'message show ' + type;
            setTimeout(() => msg.classList.remove('show'), 4000);
        }

        document.addEventListener('keypress', e => {
            if (e.key === 'Enter' && !document.getElementById('btn-print').disabled) {
                doPrint();
            }
        });
    </script>
</body>
</html>
