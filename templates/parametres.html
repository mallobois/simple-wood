<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Param√®tres - WoodStock</title>
    <style>
        :root {
            --bg: #f8f9fa; --card: #ffffff; --text: #1a1a2e; --text-muted: #6c757d;
            --primary: #2563eb; --success: #059669; --danger: #dc2626; --border: #e5e7eb;
            --radius: 12px; --shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100dvh; padding-bottom: 2rem; }
        
        header { background: var(--card); border-bottom: 1px solid var(--border); padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.75rem; position: sticky; top: 0; z-index: 10; }
        .back { color: var(--primary); text-decoration: none; font-size: 0.9rem; font-weight: 500; }
        header h1 { font-size: 1rem; font-weight: 600; }
        
        main { max-width: 700px; margin: 0 auto; padding: 1rem; }
        
        .toast { position: fixed; top: 4rem; left: 50%; transform: translateX(-50%) translateY(-20px); padding: 0.75rem 1.25rem; border-radius: 8px; font-size: 0.9rem; font-weight: 500; opacity: 0; transition: all 0.3s; z-index: 100; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--success); color: white; }
        .toast.error { background: var(--danger); color: white; }
        
        .card { background: var(--card); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; box-shadow: var(--shadow); }
        .card-title { font-size: 0.7rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.75rem; }
        
        .item-list { list-style: none; }
        .item { display: flex; align-items: center; padding: 0.625rem 0; border-bottom: 1px solid var(--bg); gap: 0.625rem; }
        .item:last-child { border-bottom: none; }
        .item-icon { width: 36px; height: 36px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
        .item-icon.round { border-radius: 50%; }
        .item-info { flex: 1; min-width: 0; }
        .item-name { font-weight: 500; font-size: 0.9rem; }
        .item-detail { font-size: 0.75rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-badge { font-size: 0.65rem; padding: 0.2rem 0.4rem; border-radius: 4px; background: var(--bg); font-weight: 600; text-transform: uppercase; }
        .item-badge.admin { background: var(--primary); color: white; }
        .item-actions { display: flex; gap: 0.375rem; flex-shrink: 0; }
        
        .btn { padding: 0.5rem 0.875rem; border: none; border-radius: 6px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.15s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-secondary { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-icon { width: 32px; height: 32px; padding: 0; background: var(--bg); border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background: var(--border); }
        .btn-icon.delete:hover { background: var(--danger); color: white; }
        .btn-full { width: 100%; padding: 0.75rem; margin-top: 0.75rem; }
        .btn-sm { padding: 0.375rem 0.625rem; font-size: 0.8rem; }
        
        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 100; padding: 1rem; }
        .modal.show { display: flex; }
        .modal-content { background: var(--card); border-radius: 16px; padding: 1.25rem; width: 100%; max-width: 480px; max-height: 85vh; overflow-y: auto; }
        .modal-content.wide { max-width: 900px; }
        .modal-content.full { max-width: 95vw; max-height: 95vh; }
        .modal h3 { font-size: 1.1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .modal-actions { display: flex; gap: 0.625rem; margin-top: 1.25rem; }
        .modal-actions .btn { flex: 1; }
        
        .form-group { margin-bottom: 0.875rem; }
        .form-group label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.375rem; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 0.625rem 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .form-row-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; }
        
        .postes-checkboxes { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .poste-checkbox { display: flex; align-items: center; gap: 0.375rem; padding: 0.375rem 0.625rem; background: var(--bg); border-radius: 6px; font-size: 0.85rem; }
        .poste-checkbox input { width: 16px; height: 16px; }
        
        /* ============================================
           TABLE VALUES - NOUVELLE INTERFACE
           ============================================ */
        
        .values-header { display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center; }
        .values-search { flex: 1; min-width: 200px; padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; }
        .values-search:focus { outline: none; border-color: var(--primary); }
        .values-count { font-size: 0.8rem; color: var(--text-muted); }
        
        /* Table view (desktop) */
        .values-table-wrapper { overflow-x: auto; margin: 0 -1.25rem; padding: 0 1.25rem; }
        .values-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; display: none; }
        .values-table th, .values-table td { padding: 0.5rem 0.625rem; text-align: left; border-bottom: 1px solid var(--border); white-space: nowrap; }
        .values-table th { background: var(--bg); font-weight: 600; font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); position: sticky; top: 0; }
        .values-table tr:hover { background: #f8fafc; }
        .values-table td:first-child { font-weight: 600; color: var(--primary); }
        .color-preview { display: inline-flex; align-items: center; gap: 0.375rem; }
        .color-swatch { width: 18px; height: 18px; border-radius: 4px; border: 1px solid var(--border); flex-shrink: 0; }
        .img-thumb { width: 32px; height: 32px; object-fit: cover; border-radius: 4px; cursor: pointer; }
        .img-thumb:hover { transform: scale(3); position: relative; z-index: 10; }
        
        /* Card view (mobile) */
        .values-cards { display: flex; flex-direction: column; gap: 0.5rem; }
        .value-card { background: var(--bg); border-radius: 10px; padding: 0.75rem; cursor: pointer; transition: all 0.15s; }
        .value-card:hover { background: #e8ecf0; }
        .value-card-main { display: flex; align-items: center; gap: 0.75rem; }
        .value-card-color { width: 40px; height: 40px; border-radius: 8px; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.15); flex-shrink: 0; }
        .value-card-info { flex: 1; min-width: 0; }
        .value-card-title { font-weight: 600; font-size: 0.95rem; }
        .value-card-subtitle { font-size: 0.8rem; color: var(--text-muted); }
        .value-card-badges { display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.375rem; }
        .value-card-badge { font-size: 0.65rem; padding: 0.15rem 0.375rem; background: white; border-radius: 4px; color: var(--text-muted); }
        .value-card-actions { display: flex; gap: 0.25rem; }
        
        /* Edit Modal - Grouped Fields */
        .field-group { margin-bottom: 1rem; }
        .field-group-title { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--primary); margin-bottom: 0.5rem; padding-bottom: 0.375rem; border-bottom: 2px solid var(--primary); display: flex; align-items: center; gap: 0.375rem; }
        .field-grid { display: grid; gap: 0.5rem; }
        .field-grid-2 { grid-template-columns: repeat(2, 1fr); }
        .field-grid-3 { grid-template-columns: repeat(3, 1fr); }
        .field-grid-4 { grid-template-columns: repeat(4, 1fr); }
        
        .field { display: flex; flex-direction: column; gap: 0.25rem; }
        .field label { font-size: 0.65rem; color: var(--text-muted); font-weight: 500; text-transform: uppercase; }
        .field input, .field select { padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; }
        .field input:focus, .field select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1); }
        .field-color { display: flex; gap: 0.5rem; align-items: flex-end; }
        .field-color input[type="text"] { flex: 1; }
        .field-color input[type="color"] { width: 40px; height: 38px; padding: 2px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; }
        
        .preview-section { display: flex; gap: 1rem; align-items: flex-start; padding: 0.75rem; background: var(--bg); border-radius: 8px; margin-top: 0.5rem; }
        .preview-color { width: 60px; height: 60px; border-radius: 8px; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .preview-image { max-width: 120px; max-height: 80px; border-radius: 6px; object-fit: cover; }
        .preview-info { flex: 1; font-size: 0.8rem; color: var(--text-muted); }
        
        /* Responsive */
        @media (min-width: 768px) {
            .values-table { display: table; }
            .values-cards { display: none; }
            .modal-content.wide { padding: 1.5rem; }
            .field-grid-2 { grid-template-columns: repeat(2, 1fr); }
            .field-grid-3 { grid-template-columns: repeat(3, 1fr); }
            .field-grid-4 { grid-template-columns: repeat(4, 1fr); }
        }
        @media (max-width: 767px) {
            .values-table { display: none; }
            .values-cards { display: flex; }
            .field-grid-2, .field-grid-3, .field-grid-4 { grid-template-columns: repeat(2, 1fr); }
            .modal-content.wide { padding: 1rem; }
        }
        @media (max-width: 400px) {
            .field-grid-2, .field-grid-3, .field-grid-4 { grid-template-columns: 1fr; }
        }
        
        /* Sync button */
        .sync-btn { background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; }
        .sync-btn:hover { background: linear-gradient(135deg, #047857 0%, #059669 100%); }
    </style>
</head>
<body>
    <header>
        <a href="/" class="back">‚Üê Accueil</a>
        <h1>Param√®tres</h1>
    </header>

    <div id="toast" class="toast"></div>

    <main>
        <!-- Tables -->
        <div class="card">
            <div class="card-title">üìã Tables de r√©f√©rence</div>
            <ul class="item-list" id="table-list"></ul>
            <button class="btn btn-primary btn-full" onclick="openTableModal()">+ Nouvelle table</button>
        </div>

        <!-- Postes -->
        <div class="card">
            <div class="card-title">üì¶ Postes de travail</div>
            <ul class="item-list" id="poste-list"></ul>
            <button class="btn btn-primary btn-full" onclick="openPosteModal()">+ Nouveau poste</button>
        </div>

        <!-- Imprimantes -->
        <div class="card">
            <div class="card-title">üñ®Ô∏è Imprimantes Zebra</div>
            <ul class="item-list" id="printer-list"></ul>
            <button class="btn btn-primary btn-full" onclick="openPrinterModal()">+ Nouvelle imprimante</button>
        </div>

        <!-- Utilisateurs -->
        <div class="card">
            <div class="card-title">üë• Utilisateurs</div>
            <ul class="item-list" id="user-list"></ul>
            <button class="btn btn-primary btn-full" onclick="openUserModal()">+ Nouvel utilisateur</button>
        </div>

        <!-- Syst√®me -->
        <div class="card">
            <div class="card-title">‚öôÔ∏è Syst√®me</div>
            <button class="btn btn-secondary" onclick="updateApp()">Mettre √† jour depuis GitHub</button>
        </div>
    </main>

    <!-- Modal Values (liste) -->
    <div class="modal" id="values-modal">
        <div class="modal-content full">
            <h3>
                <span id="values-modal-title">Valeurs</span>
                <span class="values-count" id="values-count"></span>
            </h3>
            
            <div class="values-header">
                <input type="text" class="values-search" id="values-search" placeholder="üîç Rechercher..." oninput="filterValues()">
                <button class="btn btn-primary btn-sm" onclick="openEditModal(null)">+ Ajouter</button>
                <button class="btn sync-btn btn-sm" id="sync-btn" style="display:none;" onclick="syncTable()">üîÑ Sync</button>
            </div>
            
            <!-- Table (desktop) -->
            <div class="values-table-wrapper">
                <table class="values-table" id="values-table">
                    <thead id="values-thead"></thead>
                    <tbody id="values-tbody"></tbody>
                </table>
            </div>
            
            <!-- Cards (mobile) -->
            <div class="values-cards" id="values-cards"></div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeValuesModal()">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal Edit (√©dition d'une valeur) -->
    <div class="modal" id="edit-modal">
        <div class="modal-content wide">
            <h3 id="edit-modal-title">Modifier</h3>
            <div id="edit-form"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeEditModal()">Annuler</button>
                <button class="btn btn-danger" id="edit-delete-btn" onclick="deleteCurrentRow()" style="display:none;">Supprimer</button>
                <button class="btn btn-primary" onclick="saveRow()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Modal Table -->
    <div class="modal" id="table-modal">
        <div class="modal-content">
            <h3>Nouvelle table</h3>
            <div class="form-row">
                <div class="form-group"><label>ID</label><input type="text" id="table-id" placeholder="essences"></div>
                <div class="form-group"><label>Nom</label><input type="text" id="table-nom" placeholder="Essences"></div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeTableModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveTable()">Cr√©er</button>
            </div>
        </div>
    </div>

    <!-- Modal Poste -->
    <div class="modal" id="poste-modal">
        <div class="modal-content">
            <h3 id="poste-modal-title">Nouveau poste</h3>
            <div class="form-row">
                <div class="form-group"><label>ID</label><input type="text" id="poste-id" placeholder="troncons"></div>
                <div class="form-group"><label>Nom</label><input type="text" id="poste-nom" placeholder="Tron√ßons"></div>
            </div>
            <div class="form-group"><label>Description</label><input type="text" id="poste-desc" placeholder="√âtiquetage des tron√ßons"></div>
            <div class="form-row">
                <div class="form-group"><label>S√©rie</label><input type="text" id="poste-serie" value="2501"></div>
                <div class="form-group"><label>Pr√©fixe</label><input type="text" id="poste-prefixe" placeholder="TRO-"></div>
            </div>
            <div class="form-group"><label>Imprimante</label><select id="poste-printer"></select></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePosteModal()">Annuler</button>
                <button class="btn btn-primary" onclick="savePoste()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Modal Printer -->
    <div class="modal" id="printer-modal">
        <div class="modal-content">
            <h3 id="printer-modal-title">Nouvelle imprimante</h3>
            <div class="form-row">
                <div class="form-group"><label>ID</label><input type="text" id="printer-id" placeholder="zebra1"></div>
                <div class="form-group"><label>Nom</label><input type="text" id="printer-nom" placeholder="Zebra Bureau"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Adresse IP</label><input type="text" id="printer-ip" placeholder="192.168.1.67"></div>
                <div class="form-group"><label>Port</label><input type="number" id="printer-port" value="9100"></div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePrinterModal()">Annuler</button>
                <button class="btn btn-primary" onclick="savePrinter()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Modal User -->
    <div class="modal" id="user-modal">
        <div class="modal-content">
            <h3 id="user-modal-title">Nouvel utilisateur</h3>
            <div class="form-group"><label>Identifiant</label><input type="text" id="user-id" placeholder="jean"></div>
            <div class="form-group"><label>Nom complet</label><input type="text" id="user-nom" placeholder="Jean Dupont"></div>
            <div class="form-row">
                <div class="form-group"><label>Initiales</label><input type="text" id="user-initiales" placeholder="JD" maxlength="3"></div>
                <div class="form-group"><label>Droits</label><select id="user-droits"><option value="operateur">Op√©rateur</option><option value="admin">Admin</option></select></div>
            </div>
            <div class="form-group"><label>Code PIN (6-8 chiffres)</label><input type="text" id="user-pin" placeholder="123456" maxlength="8" inputmode="numeric"></div>
            <div class="form-group"><label>Postes autoris√©s</label><div class="postes-checkboxes" id="user-postes"></div></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeUserModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveUser()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Modal Delete -->
    <div class="modal" id="delete-modal">
        <div class="modal-content">
            <h3>Confirmer la suppression ?</h3>
            <p style="color:var(--text-muted);margin-bottom:1rem;">Cette action est irr√©versible.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Annuler</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Supprimer</button>
            </div>
        </div>
    </div>

    <script>
        let printers=[], postes=[], users=[], tables=[];
        let currentTable=null, currentTableValues=[], filteredValues=[], refTableValues={};
        let editingPrinter=null, editingPoste=null, editingUser=null, editingRowId=null;
        let deleteType=null, deleteId=null;

        // Groupes de champs pour l'√©dition des essences
        const FIELD_GROUPS = {
            essences: [
                { title: 'üè∑Ô∏è Identification', icon: 'üè∑Ô∏è', fields: ['code', 'nom', 'nom_latin', 'nom_en', 'nom_de'], cols: 3 },
                { title: '‚öñÔ∏è Densit√©s', icon: '‚öñÔ∏è', fields: ['densite_frais', 'densite_sec'], cols: 2 },
                { title: 'üìê Retrait', icon: 'üìê', fields: ['psf', 'retrait_t', 'retrait_r', 'ratio_t_r'], cols: 4 },
                { title: 'üå°Ô∏è S√©chage', icon: 'üå°Ô∏è', fields: ['temp_max', 'risque_fentes', 'risque_collapse', 'duree_27mm'], cols: 4 },
                { title: 'üîß Usinage', icon: 'üîß', fields: ['durete', 'fil', 'grain'], cols: 3 },
                { title: 'üõ°Ô∏è Durabilit√©', icon: 'üõ°Ô∏è', fields: ['durabilite', 'impregnabilite', 'aubier'], cols: 3 },
                { title: 'üé® Aspect', icon: 'üé®', fields: ['couleur', 'couleur_hex', 'image_url'], cols: 1 }
            ]
        };

        // Colonnes principales √† afficher dans la table
        const MAIN_COLUMNS = {
            essences: ['Code', 'Nom', 'Densit√© sec', 'PSF %', 'Retrait T %', 'Ratio T/R', 'Temp max ¬∞C', 'Duret√© Monnin', 'Couleur hex'],
            default: null // toutes les colonnes
        };

        document.addEventListener('DOMContentLoaded', loadAll);

        async function loadAll() {
            await Promise.all([loadTables(), loadPrinters(), loadPostes(), loadUsers()]);
        }

        // === TABLES ===
        async function loadTables() {
            tables = await (await fetch('/api/tables')).json();
            document.getElementById('table-list').innerHTML = tables.map(t => `
                <li class="item">
                    <div class="item-icon">üìã</div>
                    <div class="item-info">
                        <div class="item-name">${t.nom}</div>
                        <div class="item-detail">${(t.colonnes||[]).length} colonnes</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-icon" onclick="openValuesModal('${t.id}')" title="G√©rer les valeurs">üìù</button>
                        <button class="btn-icon delete" onclick="deleteItem('table','${t.id}')" title="Supprimer">üóëÔ∏è</button>
                    </div>
                </li>
            `).join('');
        }

        function openTableModal() { 
            document.getElementById('table-id').value = '';
            document.getElementById('table-nom').value = '';
            document.getElementById('table-modal').classList.add('show'); 
        }
        function closeTableModal() { document.getElementById('table-modal').classList.remove('show'); }

        async function saveTable() {
            const res = await fetch('/api/tables', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    id: document.getElementById('table-id').value.trim(),
                    nom: document.getElementById('table-nom').value.trim(),
                    colonnes: [{id:'valeur', nom:'Valeur', type:'text'}]
                })
            });
            const r = await res.json();
            if (r.success) { showToast('Table cr√©√©e','success'); closeTableModal(); loadTables(); }
            else showToast(r.message,'error');
        }

        // === VALUES LIST ===
        async function openValuesModal(tableId) {
            currentTable = tables.find(t => t.id === tableId);
            if (!currentTable) return;
            
            document.getElementById('values-modal-title').textContent = currentTable.nom;
            document.getElementById('values-search').value = '';
            
            // Bouton sync pour essences/epaisseurs
            const syncBtn = document.getElementById('sync-btn');
            syncBtn.style.display = ['essences', 'epaisseurs'].includes(tableId) ? 'inline-flex' : 'none';
            
            // Charger les refs
            refTableValues = {};
            for (const col of (currentTable.colonnes || [])) {
                if (col.type === 'ref' && col.ref_table) {
                    refTableValues[col.ref_table] = await (await fetch('/api/tables/' + col.ref_table + '/values')).json();
                }
            }
            
            currentTableValues = await (await fetch('/api/tables/' + currentTable.id + '/values')).json();
            filteredValues = [...currentTableValues];
            
            renderValuesTable();
            renderValuesCards();
            updateCount();
            
            document.getElementById('values-modal').classList.add('show');
        }
        
        function closeValuesModal() { 
            document.getElementById('values-modal').classList.remove('show'); 
            currentTable = null; 
        }

        function filterValues() {
            const q = document.getElementById('values-search').value.toLowerCase().trim();
            if (!q) {
                filteredValues = [...currentTableValues];
            } else {
                filteredValues = currentTableValues.filter(row => 
                    Object.values(row).some(v => String(v).toLowerCase().includes(q))
                );
            }
            renderValuesTable();
            renderValuesCards();
            updateCount();
        }

        function updateCount() {
            const total = currentTableValues.length;
            const shown = filteredValues.length;
            document.getElementById('values-count').textContent = shown === total ? `(${total})` : `(${shown}/${total})`;
        }

        function renderValuesTable() {
            const cols = currentTable.colonnes || [];
            const mainCols = MAIN_COLUMNS[currentTable.id] || cols.map(c => c.nom);
            const visibleCols = cols.filter(c => mainCols.includes(c.nom));
            
            document.getElementById('values-thead').innerHTML = `
                <tr>
                    ${visibleCols.map(c => `<th>${c.nom}</th>`).join('')}
                    <th style="width:60px;"></th>
                </tr>
            `;
            
            document.getElementById('values-tbody').innerHTML = filteredValues.map(row => `
                <tr onclick="openEditModal(${row.ID})" style="cursor:pointer;">
                    ${visibleCols.map(c => {
                        const val = row[c.nom] || '';
                        if (c.id === 'couleur_hex' && val) {
                            return `<td><span class="color-preview"><span class="color-swatch" style="background:${val}"></span>${val}</span></td>`;
                        }
                        if (c.id === 'image_url' && val) {
                            return `<td><img src="${val}" class="img-thumb" onerror="this.style.display='none'"></td>`;
                        }
                        return `<td>${val}</td>`;
                    }).join('')}
                    <td>
                        <button class="btn-icon delete" onclick="event.stopPropagation();deleteRow(${row.ID})" title="Supprimer">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="99" style="text-align:center;color:var(--text-muted);padding:2rem;">Aucune donn√©e</td></tr>';
        }

        function renderValuesCards() {
            const cols = currentTable.colonnes || [];
            const codeCol = cols.find(c => c.id === 'code');
            const nomCol = cols.find(c => c.id === 'nom');
            const latinCol = cols.find(c => c.id === 'nom_latin');
            const colorCol = cols.find(c => c.id === 'couleur_hex');
            
            document.getElementById('values-cards').innerHTML = filteredValues.map(row => {
                const code = codeCol ? row[codeCol.nom] || '' : '';
                const nom = nomCol ? row[nomCol.nom] || '' : Object.values(row)[1] || '';
                const latin = latinCol ? row[latinCol.nom] || '' : '';
                const color = colorCol ? row[colorCol.nom] || '#ccc' : '#667eea';
                
                // Badges avec quelques infos cl√©s
                const badges = [];
                if (row['Densit√© sec']) badges.push(`${row['Densit√© sec']} kg/m¬≥`);
                if (row['Duret√© Monnin']) badges.push(`Duret√© ${row['Duret√© Monnin']}`);
                if (row['Durabilit√©']) badges.push(`Classe ${row['Durabilit√©']}`);
                
                return `
                    <div class="value-card" onclick="openEditModal(${row.ID})">
                        <div class="value-card-main">
                            <div class="value-card-color" style="background:${color}"></div>
                            <div class="value-card-info">
                                <div class="value-card-title">${code ? code + ' ¬∑ ' : ''}${nom}</div>
                                <div class="value-card-subtitle">${latin}</div>
                                ${badges.length ? `<div class="value-card-badges">${badges.map(b => `<span class="value-card-badge">${b}</span>`).join('')}</div>` : ''}
                            </div>
                            <div class="value-card-actions">
                                <button class="btn-icon delete" onclick="event.stopPropagation();deleteRow(${row.ID})">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('') || '<p style="text-align:center;color:var(--text-muted);padding:2rem;">Aucune donn√©e</p>';
        }

        // === EDIT MODAL ===
        function openEditModal(rowId) {
            editingRowId = rowId;
            const row = rowId ? currentTableValues.find(r => r.ID === rowId) : {};
            const cols = currentTable.colonnes || [];
            const groups = FIELD_GROUPS[currentTable.id];
            
            document.getElementById('edit-modal-title').textContent = rowId ? `Modifier #${rowId}` : 'Ajouter';
            document.getElementById('edit-delete-btn').style.display = rowId ? 'block' : 'none';
            
            let html = '';
            
            if (groups) {
                // Affichage group√©
                for (const group of groups) {
                    const groupCols = cols.filter(c => group.fields.includes(c.id));
                    if (groupCols.length === 0) continue;
                    
                    html += `<div class="field-group">`;
                    html += `<div class="field-group-title">${group.title}</div>`;
                    
                    if (group.fields.includes('couleur_hex')) {
                        // Section sp√©ciale pour les couleurs
                        html += `<div class="field-grid field-grid-2">`;
                        for (const col of groupCols) {
                            const val = row[col.nom] || '';
                            if (col.id === 'couleur_hex') {
                                html += `
                                    <div class="field">
                                        <label>${col.nom}</label>
                                        <div class="field-color">
                                            <input type="text" id="edit-${col.id}" value="${val}" placeholder="#D4A574">
                                            <input type="color" value="${val || '#D4A574'}" onchange="document.getElementById('edit-${col.id}').value=this.value">
                                        </div>
                                    </div>
                                `;
                            } else if (col.id === 'image_url') {
                                html += `
                                    <div class="field">
                                        <label>${col.nom}</label>
                                        <input type="text" id="edit-${col.id}" value="${val}" placeholder="https://...">
                                    </div>
                                `;
                            } else {
                                html += renderField(col, val);
                            }
                        }
                        html += `</div>`;
                        // Preview
                        const colorVal = row['Couleur hex'] || '#ccc';
                        const imgVal = row['Image URL'] || '';
                        html += `
                            <div class="preview-section">
                                <div class="preview-color" id="preview-color" style="background:${colorVal}"></div>
                                ${imgVal ? `<img src="${imgVal}" class="preview-image" id="preview-image" onerror="this.style.display='none'">` : '<div id="preview-image"></div>'}
                                <div class="preview-info">Aper√ßu de la couleur et de l'image</div>
                            </div>
                        `;
                    } else {
                        html += `<div class="field-grid field-grid-${group.cols}">`;
                        for (const col of groupCols) {
                            html += renderField(col, row[col.nom] || '');
                        }
                        html += `</div>`;
                    }
                    html += `</div>`;
                }
            } else {
                // Affichage simple en grille
                html += `<div class="field-grid field-grid-3">`;
                for (const col of cols) {
                    html += renderField(col, row[col.nom] || '');
                }
                html += `</div>`;
            }
            
            document.getElementById('edit-form').innerHTML = html;
            
            // Live preview pour couleur
            const colorInput = document.getElementById('edit-couleur_hex');
            if (colorInput) {
                colorInput.addEventListener('input', () => {
                    const preview = document.getElementById('preview-color');
                    if (preview) preview.style.background = colorInput.value || '#ccc';
                });
            }
            const imgInput = document.getElementById('edit-image_url');
            if (imgInput) {
                imgInput.addEventListener('change', () => {
                    let preview = document.getElementById('preview-image');
                    if (imgInput.value) {
                        if (preview.tagName !== 'IMG') {
                            const img = document.createElement('img');
                            img.id = 'preview-image';
                            img.className = 'preview-image';
                            preview.replaceWith(img);
                            preview = img;
                        }
                        preview.src = imgInput.value;
                    }
                });
            }
            
            document.getElementById('edit-modal').classList.add('show');
        }
        
        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('show');
            editingRowId = null;
        }

        function renderField(col, value) {
            const id = `edit-${col.id}`;
            
            if (col.type === 'ref' && col.ref_table) {
                const refs = refTableValues[col.ref_table] || [];
                const refCol = col.ref_col || 'nom';
                return `
                    <div class="field">
                        <label>${col.nom}</label>
                        <select id="${id}">
                            <option value="">‚Äî</option>
                            ${refs.map(r => {
                                const v = r[refCol] || r['Nom'] || r['Valeur'] || '';
                                return `<option value="${v}" ${v===value?'selected':''}>${v}</option>`;
                            }).join('')}
                        </select>
                    </div>
                `;
            }
            
            const type = col.type === 'number' ? 'number' : col.type === 'date' ? 'date' : 'text';
            const step = col.type === 'number' ? 'step="any"' : '';
            return `
                <div class="field">
                    <label>${col.nom}</label>
                    <input type="${type}" id="${id}" value="${value}" ${step}>
                </div>
            `;
        }

        async function saveRow() {
            const cols = currentTable.colonnes || [];
            const data = {};
            let hasValue = false;
            
            cols.forEach(c => {
                const el = document.getElementById('edit-' + c.id);
                if (el) { 
                    data[c.id] = el.value.trim(); 
                    if (data[c.id]) hasValue = true; 
                }
            });
            
            if (!hasValue) {
                showToast('Remplissez au moins un champ', 'error');
                return;
            }
            
            if (editingRowId) {
                await fetch('/api/tables/' + currentTable.id + '/values/' + editingRowId, {
                    method: 'PUT',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(data)
                });
                showToast('Modifi√©', 'success');
            } else {
                await fetch('/api/tables/' + currentTable.id + '/values', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(data)
                });
                showToast('Ajout√©', 'success');
            }
            
            closeEditModal();
            currentTableValues = await (await fetch('/api/tables/' + currentTable.id + '/values')).json();
            filterValues();
        }

        async function deleteRow(rowId) {
            if (!confirm('Supprimer cette entr√©e ?')) return;
            await fetch('/api/tables/' + currentTable.id + '/values/' + rowId, { method: 'DELETE' });
            showToast('Supprim√©', 'success');
            currentTableValues = await (await fetch('/api/tables/' + currentTable.id + '/values')).json();
            filterValues();
        }

        function deleteCurrentRow() {
            if (editingRowId) {
                deleteRow(editingRowId);
                closeEditModal();
            }
        }

        async function syncTable() {
            if (!confirm(`Resynchroniser toutes les ${currentTable.nom} depuis le code source ?\n\nCette action va remplacer TOUTES les donn√©es existantes.`)) return;
            
            showToast('Synchronisation en cours...', 'success');
            const endpoint = currentTable.id === 'essences' ? '/api/essences/sync' : '/api/epaisseurs/sync';
            const r = await (await fetch(endpoint, { method: 'POST' })).json();
            
            if (r.success) {
                showToast(r.message, 'success');
                currentTableValues = await (await fetch('/api/tables/' + currentTable.id + '/values')).json();
                filterValues();
            } else {
                showToast(r.message, 'error');
            }
        }

        // === PRINTERS ===
        async function loadPrinters() {
            printers = await (await fetch('/api/printers')).json();
            document.getElementById('printer-list').innerHTML = printers.map(p => `
                <li class="item">
                    <div class="item-icon">üñ®Ô∏è</div>
                    <div class="item-info">
                        <div class="item-name">${p.nom}</div>
                        <div class="item-detail">${p.ip}:${p.port}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-icon" onclick="testPrinter('${p.id}')">üîå</button>
                        <button class="btn-icon" onclick="editPrinter('${p.id}')">‚úèÔ∏è</button>
                        <button class="btn-icon delete" onclick="deleteItem('printer','${p.id}')">üóëÔ∏è</button>
                    </div>
                </li>
            `).join('');
        }

        function openPrinterModal(id=null) {
            editingPrinter = id;
            const p = id ? printers.find(x => x.id === id) : null;
            document.getElementById('printer-modal-title').textContent = id ? 'Modifier imprimante' : 'Nouvelle imprimante';
            document.getElementById('printer-id').value = p?.id || '';
            document.getElementById('printer-id').disabled = !!id;
            document.getElementById('printer-nom').value = p?.nom || '';
            document.getElementById('printer-ip').value = p?.ip || '';
            document.getElementById('printer-port').value = p?.port || 9100;
            document.getElementById('printer-modal').classList.add('show');
        }
        function closePrinterModal() { document.getElementById('printer-modal').classList.remove('show'); editingPrinter = null; }
        function editPrinter(id) { openPrinterModal(id); }

        async function savePrinter() {
            const data = {
                id: document.getElementById('printer-id').value.trim(),
                nom: document.getElementById('printer-nom').value.trim(),
                ip: document.getElementById('printer-ip').value.trim(),
                port: parseInt(document.getElementById('printer-port').value)
            };
            const res = await fetch('/api/printers', {
                method: editingPrinter ? 'PUT' : 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(data)
            });
            const r = await res.json();
            if (r.success) { showToast('Imprimante enregistr√©e','success'); closePrinterModal(); loadPrinters(); }
            else showToast(r.message,'error');
        }

        async function testPrinter(id) {
            const r = await (await fetch('/api/printers/' + id + '/test', { method: 'POST' })).json();
            showToast(r.success ? 'Test OK' : r.message, r.success ? 'success' : 'error');
        }

        // === POSTES ===
        async function loadPostes() {
            postes = await (await fetch('/api/postes')).json();
            document.getElementById('poste-list').innerHTML = postes.map(p => `
                <li class="item">
                    <div class="item-icon">üì¶</div>
                    <div class="item-info">
                        <div class="item-name">${p.nom}</div>
                        <div class="item-detail">${p.description || p.id}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-icon" onclick="editPoste('${p.id}')">‚úèÔ∏è</button>
                        <button class="btn-icon delete" onclick="deleteItem('poste','${p.id}')">üóëÔ∏è</button>
                    </div>
                </li>
            `).join('');
            updatePrinterSelects();
        }

        function updatePrinterSelects() {
            document.getElementById('poste-printer').innerHTML = printers.map(p => `<option value="${p.id}">${p.nom}</option>`).join('');
        }

        function openPosteModal(id=null) {
            editingPoste = id;
            updatePrinterSelects();
            const p = id ? postes.find(x => x.id === id) : null;
            document.getElementById('poste-modal-title').textContent = id ? 'Modifier poste' : 'Nouveau poste';
            document.getElementById('poste-id').value = p?.id || '';
            document.getElementById('poste-id').disabled = !!id;
            document.getElementById('poste-nom').value = p?.nom || '';
            document.getElementById('poste-desc').value = p?.description || '';
            document.getElementById('poste-serie').value = p?.serie || '2501';
            document.getElementById('poste-prefixe').value = p?.prefixe || '';
            if (p?.printer) document.getElementById('poste-printer').value = p.printer;
            document.getElementById('poste-modal').classList.add('show');
        }
        function closePosteModal() { document.getElementById('poste-modal').classList.remove('show'); editingPoste = null; }
        function editPoste(id) { openPosteModal(id); }

        async function savePoste() {
            const data = {
                id: document.getElementById('poste-id').value.trim(),
                nom: document.getElementById('poste-nom').value.trim(),
                description: document.getElementById('poste-desc').value.trim(),
                serie: document.getElementById('poste-serie').value.trim(),
                prefixe: document.getElementById('poste-prefixe').value.trim(),
                printer: document.getElementById('poste-printer').value
            };
            const res = await fetch(editingPoste ? '/api/postes/' + editingPoste : '/api/postes', {
                method: editingPoste ? 'PUT' : 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(data)
            });
            const r = await res.json();
            if (r.success) { showToast('Poste enregistr√©','success'); closePosteModal(); loadPostes(); }
            else showToast(r.message,'error');
        }

        // === USERS ===
        async function loadUsers() {
            users = await (await fetch('/api/users/full')).json();
            document.getElementById('user-list').innerHTML = users.map(u => `
                <li class="item">
                    <div class="item-icon round">${u.initiales}</div>
                    <div class="item-info">
                        <div class="item-name">${u.nom}</div>
                        <div class="item-detail">${u.id}</div>
                    </div>
                    <span class="item-badge ${u.droits}">${u.droits}</span>
                    <div class="item-actions">
                        <button class="btn-icon" onclick="editUser('${u.id}')">‚úèÔ∏è</button>
                        <button class="btn-icon delete" onclick="deleteItem('user','${u.id}')">üóëÔ∏è</button>
                    </div>
                </li>
            `).join('');
        }

        function openUserModal(id=null) {
            editingUser = id;
            const u = id ? users.find(x => x.id === id) : null;
            
            document.getElementById('user-postes').innerHTML = postes.map(p => `
                <label class="poste-checkbox">
                    <input type="checkbox" value="${p.id}" id="up-${p.id}" ${u?.postes?.includes(p.id)?'checked':''}>
                    ${p.nom}
                </label>
            `).join('');
            
            document.getElementById('user-modal-title').textContent = id ? 'Modifier utilisateur' : 'Nouvel utilisateur';
            document.getElementById('user-id').value = u?.id || '';
            document.getElementById('user-id').disabled = !!id;
            document.getElementById('user-nom').value = u?.nom || '';
            document.getElementById('user-initiales').value = u?.initiales || '';
            document.getElementById('user-droits').value = u?.droits || 'operateur';
            document.getElementById('user-pin').value = '';
            document.getElementById('user-pin').placeholder = id ? 'Laisser vide pour garder' : '123456';
            document.getElementById('user-modal').classList.add('show');
        }
        function closeUserModal() { document.getElementById('user-modal').classList.remove('show'); editingUser = null; }
        function editUser(id) { openUserModal(id); }

        async function saveUser() {
            const selectedPostes = postes.filter(p => document.getElementById('up-' + p.id)?.checked).map(p => p.id);
            const data = {
                id: document.getElementById('user-id').value.trim(),
                nom: document.getElementById('user-nom').value.trim(),
                initiales: document.getElementById('user-initiales').value.trim(),
                droits: document.getElementById('user-droits').value,
                password: document.getElementById('user-pin').value.trim(),
                postes: selectedPostes
            };
            const res = await fetch('/api/users', {
                method: editingUser ? 'PUT' : 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(data)
            });
            const r = await res.json();
            if (r.success) { showToast('Utilisateur enregistr√©','success'); closeUserModal(); loadUsers(); }
            else showToast(r.message,'error');
        }

        // === DELETE ===
        function deleteItem(type, id) {
            deleteType = type;
            deleteId = id;
            document.getElementById('delete-modal').classList.add('show');
        }
        function closeDeleteModal() { document.getElementById('delete-modal').classList.remove('show'); }

        async function confirmDelete() {
            const urls = { printer: '/api/printers/', poste: '/api/postes/', table: '/api/tables/', user: '/api/users/' };
            const r = await (await fetch(urls[deleteType] + deleteId, { method: 'DELETE' })).json();
            if (r.success) {
                showToast('Supprim√©','success');
                if (deleteType === 'printer') loadPrinters();
                else if (deleteType === 'poste') loadPostes();
                else if (deleteType === 'table') loadTables();
                else loadUsers();
            } else showToast(r.message,'error');
            closeDeleteModal();
        }

        async function updateApp() {
            const r = await (await fetch('/api/update', { method: 'POST' })).json();
            showToast(r.message, r.success ? 'success' : 'error');
        }

        function showToast(text, type) {
            const t = document.getElementById('toast');
            t.textContent = text;
            t.className = 'toast show ' + type;
            setTimeout(() => t.classList.remove('show'), 2500);
        }
    </script>
</body>
</html>
